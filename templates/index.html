<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTBA Swarm Map</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { padding-top: 60px; }
        #map {
            height: 70vh;
            width: 100%;
            margin-bottom: 15px;
        }
        .leaflet-control-locate a {
            font-size: 1.4em;
            color: #333;
            cursor: pointer;
        }
        .leaflet-control-locate a:hover {
            color: #007bff;
        }
        /* Custom marker colors using CSS (more flexible than just icon URLs) */
        .leaflet-marker-icon.red-marker {
            filter: hue-rotate(0deg) saturate(100%) brightness(1.7);
        }
        .leaflet-marker-icon.green-marker {
            filter: hue-rotate(120deg) saturate(100%) brightness(1.2);
        }
        .leaflet-marker-icon.pink-marker {
            filter: hue-rotate(300deg) saturate(100%) brightness(1.7);
        }
        .leaflet-marker-icon.blue-marker {
            filter: hue-rotate(240deg) saturate(100%) brightness(1.7);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="#">UTBA Swarm Map</a>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div id="map"></div>
            </div>
        </div>
        <div class="row mt-1 mb-3">
            <div class="col-md-12 text-center">
                <button id="reportSwarmBtn" class="btn btn-primary mr-2">Report Swarm at My Location</button>
                <small class="text-muted"> (Or click on the map to report at a specific spot)</small>
            </div>
        </div>
    </div>

    <!-- Report Swarm Modal -->
    <div class="modal fade" id="reportSwarmModal" tabindex="-1" role="dialog" aria-labelledby="reportSwarmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportSwarmModalLabel">Report Bee Swarm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="reportSwarmForm">
                        <div class="form-group">
                            <label for="description">Description (e.g., size of swarm, height from ground, on a tree branch)</label>
                            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="media">Upload Photo/Video (Optional)</label>
                            <input type="file" class="form-control-file" id="media" name="media" accept="image/*,video/*" capture="environment">
                            <img id="mediaPreview" src="#" alt="Media Preview" style="max-width: 100%; max-height: 200px; margin-top: 10px; display: none;"/>
                        </div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <button type="submit" class="btn btn-primary">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TODO: Add a separate modal for UTBA members to update status -->

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        const map = L.map('map').setView([43.6532, -79.3832], 12); // Default to Toronto
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let userClickedMarker; // Marker for where user clicks to report
        let currentLocationMarker; // Marker for user's actual geolocation
        let reportedSwarmMarkers = new Map(); // Use a Map to easily update/remove markers by swarm ID

        // Custom "Center on My Location" control
        L.Control.Locate = L.Control.extend({
            onAdd: function(map) {
                var div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom leaflet-control-locate');
                div.innerHTML = '<a href="#" title="Center on my location"><i class="fas fa-map-marker-alt"></i></a>';
                div.onclick = function(e){
                    e.stopPropagation(); // prevent map click
                    locateUser(true); // true to pan the map
                }
                return div;
            },
            onRemove: function(map) {}
        });
        L.control.locate = function(opts) {
            return new L.Control.Locate(opts);
        }
        L.control.locate({ position: 'topleft' }).addTo(map);

        function getMarkerClass(status) {
            switch (status) {
                case "Reported": return 'red-marker';
                case "Verified": return 'pink-marker';
                case "Captured": return 'green-marker';
                case "Archived": return 'blue-marker'; // For old, non-captured swarms
                default: return 'red-marker'; // Default
            }
        }

        async function fetchAndDisplaySwarms() {
            try {
                const response = await fetch('/get_swarms');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const swarms = await response.json() || [];

                const currentSwarmIDs = new Set(swarms.map(s => s.id));

                reportedSwarmMarkers.forEach((marker, id) => {
                    if (!currentSwarmIDs.has(id)) {
                        map.removeLayer(marker);
                        reportedSwarmMarkers.delete(id);
                    }
                });

                swarms.forEach(swarm => {
                    // Use swarm.displayStatus for marker color, but actual swarm.status for popup text for clarity
                    const markerClassName = getMarkerClass(swarm.displayStatus || swarm.status);
                    const popupContent = `ID: ${swarm.id}<br>Status: ${swarm.status}<br>${swarm.description || "Reported Swarm"}`;

                    let existingMarker = reportedSwarmMarkers.get(swarm.id);

                    if (existingMarker) {
                        existingMarker.setLatLng([swarm.latitude, swarm.longitude]);
                        existingMarker.setPopupContent(popupContent);
                        // Efficiently update icon class only if necessary
                        const currentIconClass = existingMarker.options.icon.options.className;
                        if (currentIconClass !== markerClassName) {
                            existingMarker.setIcon(L.divIcon({ className: markerClassName, iconSize: [25, 41], iconAnchor: [12, 41] }));
                        }
                    } else {
                        const newMarker = L.marker([swarm.latitude, swarm.longitude], {
                             icon: L.divIcon({ className: markerClassName, iconSize: [25, 41], iconAnchor: [12, 41] })
                        }).addTo(map).bindPopup(popupContent);
                        reportedSwarmMarkers.set(swarm.id, newMarker);
                    }
                });
            } catch (error) {
                console.error("Could not fetch swarms:", error);
            }
        }
        
        function locateUser(panToLocation = false) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLatLng = [position.coords.latitude, position.coords.longitude];
                    if (panToLocation) {
                         map.setView(userLatLng, 15); // Zoom in closer when centering
                    }
                    if (currentLocationMarker) {
                        currentLocationMarker.setLatLng(userLatLng);
                    } else {
                        currentLocationMarker = L.marker(userLatLng, {alt: 'Current Location'}).addTo(map).bindPopup("Your Current Location");
                    }
                    currentLocationMarker.openPopup();
                }, function() {
                    console.log("Geolocation failed or was denied.");
                    alert("Could not get your location. Please ensure location services are enabled and permissions are granted.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
        locateUser(); // Attempt to locate user on page load, but don't pan

        const reportSwarmBtn = document.getElementById('reportSwarmBtn');
        const reportSwarmModal = new bootstrap.Modal(document.getElementById('reportSwarmModal'));
        const reportSwarmForm = document.getElementById('reportSwarmForm');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const mediaInput = document.getElementById('media');
        const mediaPreview = document.getElementById('mediaPreview');

        reportSwarmBtn.addEventListener('click', function() {
            if (currentLocationMarker) {
                const latLng = currentLocationMarker.getLatLng();
                latitudeInput.value = latLng.lat;
                longitudeInput.value = latLng.lng;
                if (userClickedMarker) map.removeLayer(userClickedMarker); // Remove map-click marker if exists
                reportSwarmModal.show();
            } else {
                locateUser(true); // Try to locate and pan, then user can click again if needed
                alert("Trying to get your location. If successful, click 'Report Swarm' again. Otherwise, click on the map.");
            }
        });

        map.on('click', function(e) {
            if (userClickedMarker) {
                map.removeLayer(userClickedMarker);
            }
            userClickedMarker = L.marker(e.latlng).addTo(map).bindPopup("Chosen Swarm Location");
            latitudeInput.value = e.latlng.lat;
            longitudeInput.value = e.latlng.lng;
            reportSwarmModal.show();
        });

        mediaInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mediaPreview.src = e.target.result;
                    mediaPreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                mediaPreview.src = "#";
                mediaPreview.style.display = 'none';
            }
        });

        reportSwarmForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const formData = new FormData(reportSwarmForm);
            
            try {
                const response = await fetch('/report_swarm', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const newReport = await response.json(); // Backend now returns the created report
                    alert(`Report ID: ${newReport.id} submitted successfully!`);
                    reportSwarmModal.hide();
                    reportSwarmForm.reset(); 
                    mediaPreview.style.display = 'none';
                    if(userClickedMarker) map.removeLayer(userClickedMarker); // Remove the temporary click marker
                    fetchAndDisplaySwarms(); 
                } else {
                    const errorText = await response.text();
                    alert(`Error submitting report: ${errorText}`);
                }
            } catch (error) {
                console.error("Failed to submit report:", error);
                alert("Failed to submit report. Check console for details.");
            }
        });

        // Initial fetch of swarms
        fetchAndDisplaySwarms();

        // Example of how to call update_swarm_status (for testing/dev purposes)
        // You would build a proper UI for UTBA members for this.
        async function exampleUpdateStatus(reportId, newStatus, notes) {
            try {
                const response = await fetch('/update_swarm_status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: reportId, status: newStatus, beekeeperNotes: notes })
                });
                if (response.ok) {
                    const updatedReport = await response.json();
                    console.log("Update successful:", updatedReport);
                    fetchAndDisplaySwarms(); // Refresh map
                } else {
                    const errorText = await response.text();
                    console.error("Failed to update status:", errorText);
                    alert("Failed to update status: " + errorText);
                }
            } catch (error) {
                console.error("Error updating status:", error);
            }
        }
        // To test: find a report ID from console after submitting, then call:
        // exampleUpdateStatus("1", "Captured", "Successfully collected the swarm.");
    </script>
</body>
</html> 